<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facial Recognition</title>
    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</head>
<body>
    <h1>User Profiles</h1>
    {% for profile in profiles %}
        <div>
            <img src="{{ profile.imagen.url }}" alt="{{ profile.nombre }} {{ profile.apellido }}">
        </div>
    {% endfor %}

    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>

<!-- En la sección <script> de templates/index.html -->
<script>
    function onOpenCvReady() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                video.srcObject = stream;
                video.play();

                const processVideo = () => {
                    context.drawImage(video, 0, 0, video.width, video.height);
                    const imageData = context.getImageData(0, 0, video.width, video.height);

                    // Convierte imageData a una matriz Mat de OpenCV.js
                    const src = cv.matFromImageData(imageData);

                    // Convierte la imagen a escala de grises
                    const gray = new cv.Mat();
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

                    // Detecta caras utilizando un clasificador en cascada preentrenado
                    const faceCascade = new cv.CascadeClassifier();
                    faceCascade.load('haarcascade_frontalface_default.xml');

                    const faces = new cv.RectVector();
                    const size = new cv.Size(0, 0);
                    faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, size, size);

                    // Dibuja rectángulos alrededor de las caras detectadas
                    for (let i = 0; i < faces.size(); ++i) {
                        const face = faces.get(i);
                        const point1 = new cv.Point(face.x, face.y);
                        const point2 = new cv.Point(face.x + face.width, face.y + face.height);
                        cv.rectangle(src, point1, point2, [255, 0, 0, 255]);
                    }

                    // Muestra el resultado en el canvas
                    cv.imshow(canvas, src);

                    // Libera la memoria
                    src.delete();
                    gray.delete();
                    faces.delete();

                    // Llama recursivamente a processVideo para procesar el siguiente cuadro
                    requestAnimationFrame(processVideo);
                };

                // Comienza el procesamiento del video
                requestAnimationFrame(processVideo);
            })
            .catch((error) => {
                console.error('Error al acceder a la cámara: ', error);
            });
    }
</script>
</body>
</html>
